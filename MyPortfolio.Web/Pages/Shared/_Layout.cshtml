<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - My Portfolio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="manifest" href="~/manifest.json">
    <meta name="theme-color" content="#1db954">
</head>
<body>
    <div class="aurora-bg-container">
        <div class="aurora-blob blob-1"></div>
        <div class="aurora-blob blob-2"></div>
        <div class="aurora-blob blob-3"></div>
    </div>

    <div class="spotify-layout">
        <div class="sidebar">
            <a href="/" class="d-flex align-items-center gap-2 mb-4 text-decoration-none text-white fs-4 fw-bold ps-2">
                <i class="fab fa-spotify text-success fa-lg"></i>
                <span class="glitch-text" data-text="PORTFOLIO" style="font-size: 1.5rem;">PORTFOLIO</span>
            </a>

            <div class="nav-links">
                <a href="/" class="nav-btn @(ViewContext.RouteData.Values["page"]?.ToString() == "/Index" && Context.Request.Query["Mode"] != "library" ? "active" : "")">
                    <i class="fas fa-home"></i> Home
                </a>

                <a href="/Profile" class="nav-btn @(ViewContext.RouteData.Values["page"]?.ToString() == "/Profile" ? "active" : "")">
                    <i class="fas fa-user-astronaut"></i> Tech Profile
                </a>

                <a href="/Portfolio/Details/4" class="nav-btn">
                    <i class="fas fa-file-code"></i> Live CV
                </a>

                <div class="mt-4 mb-2 px-3 text-uppercase text-white-50 small fw-bold" style="letter-spacing: 1px;">Library</div>

                <a href="/?Mode=library" class="nav-btn @(Context.Request.Query["Mode"] == "library" ? "active" : "")">
                    <i class="fas fa-heart text-danger"></i> Liked Songs
                </a>
                <a href="/Admin/Dashboard" class="neumorph-btn btn-sm rounded-pill text-decoration-none py-2 mb-2 w-100 text-warning">
                    <i class="fas fa-chart-line me-2"></i> Dashboard
                </a>
                @if (User.Identity.IsAuthenticated)
                {
                    <div class="mt-4 p-3 glass-panel text-center">
                        <div class="small text-white-50 mb-2">Admin Panel</div>
                        <a href="/Portfolio/Create" class="neumorph-btn btn-sm rounded-pill text-decoration-none py-2 mb-2 w-100">
                            <i class="fas fa-plus me-2"></i> New Project
                        </a>
                        <a href="/Login?handler=Logout" class="text-danger small text-decoration-none hover-underline">Logout</a>
                    </div>
                }
                else
                {
                    <a href="/Login" class="nav-btn mt-auto">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </a>
                }
            </div>
        </div>

        <div class="main-view">
            @RenderBody()
        </div>

        <div class="player-bar">
            <div class="d-flex align-items-center gap-3" style="width: 30%;">
                <img id="current-img" src="https://via.placeholder.com/50" style="width: 50px; height: 50px; border-radius: 8px; display: none; object-fit: cover; box-shadow: 0 0 10px rgba(0,0,0,0.5);" />
                <div id="song-info" style="display: none;">
                    <div id="current-title" class="text-white fw-bold small">Chọn bài hát...</div>
                    <div id="current-desc" class="text-white-50 small" style="font-size: 0.7rem;">...</div>
                </div>
            </div>

            <div class="d-flex flex-column align-items-center justify-content-center" style="width: 40%;">
                <div class="d-flex align-items-center gap-3 mb-2">
                    <button class="btn-control" id="shuffle-btn" onclick="toggleShuffle()" title="Shuffle"><i class="fas fa-random"></i></button>
                    <button class="btn-control" onclick="prevSong()" title="Previous"><i class="fas fa-step-backward"></i></button>
                    <button class="btn-play-round" onclick="togglePlay()" title="Play/Pause"><i class="fas fa-play" id="play-icon"></i></button>
                    <button class="btn-control" onclick="nextSong()" title="Next"><i class="fas fa-step-forward"></i></button>
                    <button class="btn-control" id="repeat-btn" onclick="toggleRepeat()" title="Repeat"><i class="fas fa-redo"></i></button>
                </div>
                <div class="d-flex align-items-center gap-2 w-100">
                    <span id="current-time" class="small text-white-50">0:00</span>
                    <div class="progress-bar-wrapper flex-grow-1" style="height: 4px; background: #444; border-radius: 2px; cursor: pointer;">
                        <div id="progress-bar" style="width: 0%; height: 100%; background: #1db954; border-radius: 2px;"></div>
                    </div>
                    <span id="duration-time" class="small text-white-50">0:00</span>
                </div>
            </div>

            <div class="d-flex justify-content-end align-items-center" style="width: 30%;">
                <button class="btn-control me-2" onclick="toggleMute()"><i class="fas fa-volume-up" id="volume-icon"></i></button>
                <input type="range" id="volume-slider" min="0" max="1" step="0.01" class="form-range" style="width: 80px;">
            </div>
        </div>
    </div>

    <audio id="audio-player"></audio>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>

    <script>
        // --- 1. KHỞI TẠO BIẾN ---
        var audio = document.getElementById("audio-player");
        var playIcon = document.getElementById("play-icon");
        var progressBar = document.getElementById("progress-bar");
        var currentTimeLabel = document.getElementById("current-time");
        var durationTimeLabel = document.getElementById("duration-time");
        var repeatBtn = document.getElementById("repeat-btn");
        var shuffleBtn = document.getElementById("shuffle-btn");
        var volumeSlider = document.getElementById("volume-slider");
        var volumeIcon = document.getElementById("volume-icon");

        var isRepeat = false;
        var isShuffle = false;
        var playlist = [];
        var currentIndex = -1;
        var lastVolume = 1;

        // ==========================================
        // 🔥 SIGNALR SETUP (TÍNH NĂNG NGHE CHUNG)
        // ==========================================
        var connection = new signalR.HubConnectionBuilder().withUrl("/musicHub").build();

        // 1. Nhận lệnh từ người khác (Server -> Client)
        connection.on("ReceiveMusicAction", function (action, url, time) {
            console.log("Nhận lệnh: " + action);
            if (action === "play") {
                if (audio.src !== url) { // Nếu khác bài thì đổi bài
                    audio.src = url;
                    // Cần cập nhật lại UI tên bài hát nếu có thể (Ở mức đơn giản thì chỉ cần nhạc chạy đúng)
                }
                if (Math.abs(audio.currentTime - time) > 1) { // Đồng bộ thời gian nếu lệch > 1s
                    audio.currentTime = time;
                }
                audio.play();
                updatePlayIcon(true);
            } else if (action === "pause") {
                audio.pause();
                updatePlayIcon(false);
            }
        });

        // 2. Bắt đầu kết nối
        connection.start().then(function () {
            console.log("Đã kết nối vào phòng nhạc!");
        }).catch(function (err) {
            return console.error(err.toString());
        });
        // ==========================================


        // --- 2. HÀM PHÁT NHẠC & XỬ LÝ PLAYLIST ---
        function playMusic(url, title, img, desc, artist, listData) {
            if (listData) {
                playlist = listData.map(item => ({
                    audioUrl: item.audioUrl || item.AudioUrl,
                    title: item.title || item.Title,
                    imageUrl: item.imageUrl || item.ImageUrl,
                    artist: item.artist || item.Artist
                }));
            } else if (playlist.length === 0) {
                playlist = [{ audioUrl: url, title: title, imageUrl: img, artist: artist }];
            }

            var foundIndex = playlist.findIndex(p => p.audioUrl === url);
            if (foundIndex !== -1) {
                currentIndex = foundIndex;
            } else {
                playlist.unshift({ audioUrl: url, title: title, imageUrl: img, artist: artist });
                currentIndex = 0;
            }
            loadSong(playlist[currentIndex]);

            // 🔥 Gửi lệnh Play ngay khi chọn bài
            if (connection.state === signalR.HubConnectionState.Connected) {
                connection.invoke("SendMusicAction", "play", url, 0);
            }
        }

        function loadSong(song) {
            if (!song || !song.audioUrl) return;
            document.getElementById("current-title").innerText = song.title;
            document.getElementById("current-desc").innerText = song.artist || "Unknown";
            document.getElementById("current-img").src = song.imageUrl;
            document.getElementById("current-img").style.display = "block";
            document.getElementById("song-info").style.display = "block";

            if (audio.src !== song.audioUrl) {
                audio.src = song.audioUrl;
                audio.play();
                updatePlayIcon(true);
            } else {
                if (audio.paused) {
                    audio.play();
                    updatePlayIcon(true);
                }
            }
        }

        // --- 3. CÁC NÚT ĐIỀU KHIỂN (CÓ SIGNALR) ---
        function togglePlay() {
            if (!audio.src) return;

            if (audio.paused) {
                audio.play();
                updatePlayIcon(true);
                // 🔥 Gửi lệnh PLAY cho mọi người
                if (connection.state === signalR.HubConnectionState.Connected) {
                    connection.invoke("SendMusicAction", "play", audio.src, audio.currentTime);
                }
            } else {
                audio.pause();
                updatePlayIcon(false);
                // 🔥 Gửi lệnh PAUSE cho mọi người
                if (connection.state === signalR.HubConnectionState.Connected) {
                    connection.invoke("SendMusicAction", "pause", audio.src, audio.currentTime);
                }
            }
        }

        function updatePlayIcon(isPlaying) {
            if (isPlaying) {
                playIcon.classList.remove("fa-play");
                playIcon.classList.add("fa-pause");
            } else {
                playIcon.classList.remove("fa-pause");
                playIcon.classList.add("fa-play");
            }
        }

        function nextSong() {
            if (playlist.length === 0) return;
            if (isShuffle) {
                var newIndex;
                do { newIndex = Math.floor(Math.random() * playlist.length); }
                while (newIndex === currentIndex && playlist.length > 1);
                currentIndex = newIndex;
            } else {
                currentIndex++;
                if (currentIndex >= playlist.length) currentIndex = 0;
            }
            loadSong(playlist[currentIndex]);

            // 🔥 Đồng bộ khi chuyển bài
            if (connection.state === signalR.HubConnectionState.Connected) {
                connection.invoke("SendMusicAction", "play", playlist[currentIndex].audioUrl, 0);
            }
        }

        function prevSong() {
            if (playlist.length === 0) return;
            if (audio.currentTime > 3) { audio.currentTime = 0; return; }
            if (isShuffle) {
                var newIndex;
                do { newIndex = Math.floor(Math.random() * playlist.length); }
                while (newIndex === currentIndex && playlist.length > 1);
                currentIndex = newIndex;
            } else {
                currentIndex--;
                if (currentIndex < 0) currentIndex = playlist.length - 1;
            }
            loadSong(playlist[currentIndex]);

            // 🔥 Đồng bộ khi chuyển bài
            if (connection.state === signalR.HubConnectionState.Connected) {
                connection.invoke("SendMusicAction", "play", playlist[currentIndex].audioUrl, 0);
            }
        }

        function toggleShuffle() {
            isShuffle = !isShuffle;
            shuffleBtn.style.color = isShuffle ? "#1db954" : "#b3b3b3";
        }

        function toggleRepeat() {
            isRepeat = !isRepeat;
            repeatBtn.style.color = isRepeat ? "#1db954" : "#b3b3b3";
        }

        // --- 4. SỰ KIỆN AUDIO ---
        audio.addEventListener("timeupdate", function() {
            if (audio.duration) {
                var percent = (audio.currentTime / audio.duration) * 100;
                progressBar.style.width = percent + "%";
                currentTimeLabel.innerText = formatTime(audio.currentTime);
                window.dispatchEvent(new CustomEvent('audioTimeUpdate', { detail: { currentTime: audio.currentTime } }));
            }
        });

        audio.addEventListener("loadedmetadata", function() {
            durationTimeLabel.innerText = formatTime(audio.duration);
        });

        audio.addEventListener("ended", function() {
            if (isRepeat) {
                audio.currentTime = 0;
                audio.play();
            } else {
                nextSong();
            }
        });

        document.querySelector(".progress-bar-wrapper").addEventListener("click", function(e) {
             if (audio.duration) {
                var rect = this.getBoundingClientRect();
                var percent = (e.clientX - rect.left) / rect.width;
                var newTime = percent * audio.duration;
                audio.currentTime = newTime;

                // 🔥 Khi tua nhạc cũng đồng bộ
                if (connection.state === signalR.HubConnectionState.Connected) {
                    connection.invoke("SendMusicAction", "play", audio.src, newTime);
                }
            }
        });

        // --- 5. LOGIC ÂM LƯỢNG ---
        function setVolume(val) {
            audio.volume = val;
            updateVolumeIcon(val);
        }

        function toggleMute() {
            if (audio.volume > 0) {
                lastVolume = audio.volume;
                setVolume(0);
                volumeSlider.value = 0;
            } else {
                setVolume(lastVolume);
                volumeSlider.value = lastVolume;
            }
        }

        function updateVolumeIcon(vol) {
            volumeIcon.className = '';
            if (vol == 0) volumeIcon.className = 'fas fa-volume-mute';
            else if (vol < 0.5) volumeIcon.className = 'fas fa-volume-down';
            else volumeIcon.className = 'fas fa-volume-up';
        }

        volumeSlider.oninput = function() { setVolume(this.value); };

        function formatTime(s) {
            if (isNaN(s)) return "0:00";
            var m = Math.floor(s / 60);
            var sec = Math.floor(s % 60);
            return m + ":" + (sec < 10 ? "0" : "") + sec;
        }

        setVolume(1);
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>