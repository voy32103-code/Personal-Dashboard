<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - My Spotify Portfolio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
</head>
<body>
    <div class="spotify-layout">

        <div class="sidebar">
            <a href="/" class="logo">
                <i class="fab fa-spotify"></i> My Portfolio
            </a>

            <div class="nav-links">
                <a href="/" class="nav-btn ..."><i class="fas fa-home"></i> Home</a>

                <a href="/Profile" class="nav-btn">
                    <i class="fas fa-user-circle"></i> About Me
                </a>

                <a href="/Portfolio/Details/4" class="nav-btn">
                    <i class="fas fa-file-alt"></i> My CV (Resume)
                </a>

                <div style="height: 16px;"></div>

                <div class="text-uppercase text-muted fw-bold small px-4 mb-2" style="font-size: 0.7rem; letter-spacing: 1px;">
                    Playlists (Projects)
                </div>

                <a href="#" class="nav-btn"><i class="fas fa-globe"></i> Web Apps</a>
                <a href="#" class="nav-btn"><i class="fas fa-mobile-alt"></i> Mobile Apps</a>
                <a href="#" class="nav-btn"><i class="fas fa-gamepad"></i> Game Dev</a>
            </div>
        </div>

        <div class="main-view">
            @RenderBody()
        </div>

        <div class="player-bar">
            <div class="player-info">
                <img id="current-img" src="https://via.placeholder.com/56" style="width: 56px; height: 56px; border-radius: 4px; display: none; object-fit: cover;" />
                <div id="song-info" style="display: none;">
                    <div id="current-title" class="player-song-title">...</div>
                    <div id="current-desc" class="player-song-artist">...</div>
                </div>
            </div>

            <div class="player-controls">
                <div class="control-buttons">
                    <button class="btn-control" id="shuffle-btn" onclick="toggleShuffle()" title="Shuffle">
                        <i class="fas fa-random"></i>
                    </button>
                    <button class="btn-control" onclick="prevSong()" title="Previous">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button class="btn-control btn-play-pause" onclick="togglePlay()" title="Play/Pause">
                        <i class="fas fa-play" id="play-icon"></i>
                    </button>
                    <button class="btn-control" onclick="nextSong()" title="Next">
                        <i class="fas fa-step-forward"></i>
                    </button>
                    <button class="btn-control btn-repeat" id="repeat-btn" onclick="toggleRepeat()" title="Repeat">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
                <div class="progress-bar-container">
                    <span id="current-time" class="time-label">0:00</span>
                    <div class="progress-bar-wrapper">
                        <div class="progress-bar-bg">
                            <div id="progress-bar" class="progress-bar-fill"></div>
                        </div>
                    </div>
                    <span id="duration-time" class="time-label">0:00</span>
                </div>
            </div>

            <div class="player-right">
                <button class="btn-control" onclick="toggleMute()" id="volume-btn">
                    <i class="fas fa-volume-up" id="volume-icon"></i>
                </button>
                <div class="volume-bar-wrapper">
                    <input type="range" id="volume-slider" class="volume-slider" min="0" max="1" step="0.01" value="1" oninput="setVolume(this.value)">
                </div>
            </div>
        </div>
    </div>

    <audio id="audio-player"></audio>

    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>

    <script>
        // --- 1. KHỞI TẠO BIẾN ---
        var audio = document.getElementById("audio-player");
        var playIcon = document.getElementById("play-icon");
        var progressBar = document.getElementById("progress-bar");
        var currentTimeLabel = document.getElementById("current-time");
        var durationTimeLabel = document.getElementById("duration-time");
        var repeatBtn = document.getElementById("repeat-btn");
        var shuffleBtn = document.getElementById("shuffle-btn");
        var volumeSlider = document.getElementById("volume-slider");
        var volumeIcon = document.getElementById("volume-icon");

        var isRepeat = false;
        var isShuffle = false;
        var playlist = [];
        var currentIndex = -1;
        var lastVolume = 1;

        // --- 2. HÀM PHÁT NHẠC (NÂNG CẤP: Hỗ trợ Playlist) ---
        function playMusic(url, title, img, desc, artist, listData) {
            // Xử lý Playlist nếu có
            if (listData) {
                // Map dữ liệu từ C# sang JS object
                playlist = listData.map(item => ({
                    audioUrl: item.audioUrl || item.AudioUrl,
                    title: item.title || item.Title,
                    imageUrl: item.imageUrl || item.ImageUrl,
                    artist: item.artist || item.Artist
                }));
            } else if (playlist.length === 0) {
                // Nếu chưa có playlist, tạo playlist 1 bài
                playlist = [{ audioUrl: url, title: title, imageUrl: img, artist: artist }];
            }

            // Tìm bài hát trong playlist
            var foundIndex = playlist.findIndex(p => p.audioUrl === url);
            if (foundIndex !== -1) {
                currentIndex = foundIndex;
            } else {
                // Trường hợp đặc biệt: thêm bài mới vào đầu
                playlist.unshift({ audioUrl: url, title: title, imageUrl: img, artist: artist });
                currentIndex = 0;
            }

            loadSong(playlist[currentIndex]);
        }

        // Hàm nội bộ load bài
        function loadSong(song) {
            if (!song || !song.audioUrl) return;

            document.getElementById("current-title").innerText = song.title;
            document.getElementById("current-desc").innerText = song.artist || "Unknown";
            document.getElementById("current-img").src = song.imageUrl;
            document.getElementById("current-img").style.display = "block";
            document.getElementById("song-info").style.display = "block";

            // Chỉ nạp lại nếu khác src để tránh giật
            if (audio.src !== song.audioUrl) {
                audio.src = song.audioUrl;
                audio.play();
                updatePlayIcon(true);
            } else {
                if (audio.paused) {
                    audio.play();
                    updatePlayIcon(true);
                }
            }
        }

        // --- 3. ĐIỀU KHIỂN ---
        function togglePlay() {
            if (!audio.src) return;
            if (audio.paused) { audio.play(); updatePlayIcon(true); }
            else { audio.pause(); updatePlayIcon(false); }
        }

        function updatePlayIcon(isPlaying) {
            if (isPlaying) { playIcon.classList.remove("fa-play"); playIcon.classList.add("fa-pause"); }
            else { playIcon.classList.remove("fa-pause"); playIcon.classList.add("fa-play"); }
        }

        function nextSong() {
            if (playlist.length === 0) return;
            if (isShuffle) {
                let newIndex;
                do { newIndex = Math.floor(Math.random() * playlist.length); }
                while (newIndex === currentIndex && playlist.length > 1);
                currentIndex = newIndex;
            } else {
                currentIndex++;
                if (currentIndex >= playlist.length) currentIndex = 0;
            }
            loadSong(playlist[currentIndex]);
        }

        function prevSong() {
            if (playlist.length === 0) return;
            if (audio.currentTime > 3) { audio.currentTime = 0; return; }

            if (isShuffle) {
                let newIndex;
                do { newIndex = Math.floor(Math.random() * playlist.length); }
                while (newIndex === currentIndex && playlist.length > 1);
                currentIndex = newIndex;
            } else {
                currentIndex--;
                if (currentIndex < 0) currentIndex = playlist.length - 1;
            }
            loadSong(playlist[currentIndex]);
        }

        function toggleShuffle() {
            isShuffle = !isShuffle;
            shuffleBtn.style.color = isShuffle ? "#1db954" : "#b3b3b3";
        }

        function toggleRepeat() {
            isRepeat = !isRepeat;
            repeatBtn.style.color = isRepeat ? "#1db954" : "#b3b3b3";
        }

        // --- 4. VOLUME ---
        function setVolume(val) {
            audio.volume = val;
            updateVolumeIcon(val);
            var percent = val * 100;
            volumeSlider.style.background = `linear-gradient(to right, #1db954 ${percent}%, #4d4d4d ${percent}%)`;
        }

        function toggleMute() {
            if (audio.volume > 0) {
                lastVolume = audio.volume;
                audio.volume = 0;
                volumeSlider.value = 0;
                setVolume(0);
            } else {
                audio.volume = lastVolume;
                volumeSlider.value = lastVolume;
                setVolume(lastVolume);
            }
        }

        function updateVolumeIcon(vol) {
            volumeIcon.className = '';
            if (vol == 0) volumeIcon.className = 'fas fa-volume-mute';
            else if (vol < 0.5) volumeIcon.className = 'fas fa-volume-down';
            else volumeIcon.className = 'fas fa-volume-up';
        }

        // --- 5. EVENTS ---
        audio.addEventListener("timeupdate", function() {
            if (audio.duration) {
                var percent = (audio.currentTime / audio.duration) * 100;
                progressBar.style.width = percent + "%";
                currentTimeLabel.innerText = formatTime(audio.currentTime);
                // Gửi event cho Lyrics
                window.dispatchEvent(new CustomEvent('audioTimeUpdate', { detail: { currentTime: audio.currentTime } }));
            }
        });

        audio.addEventListener("loadedmetadata", function() {
            durationTimeLabel.innerText = formatTime(audio.duration);
        });

        audio.addEventListener("ended", function() {
            if (isRepeat) {
                audio.currentTime = 0; audio.play();
            } else {
                nextSong();
            }
        });

        // Seek (Tua nhạc)
        document.querySelector(".progress-bar-wrapper").addEventListener("click", function(e) {
             if (audio.duration) {
                var rect = this.getBoundingClientRect();
                var percent = (e.clientX - rect.left) / rect.width;
                audio.currentTime = percent * audio.duration;
            }
        });

        // Helper & Search
        function formatTime(s) {
            if (isNaN(s)) return "0:00";
            var m = Math.floor(s / 60);
            var sec = Math.floor(s % 60);
            return m + ":" + (sec < 10 ? "0" : "") + sec;
        }

        function activateSearch() {
             var searchBox = document.getElementById("search-container");
             if(searchBox) {
                 searchBox.style.display = "block";
                 searchBox.querySelector("input")?.focus();
             } else if (window.location.pathname !== "/") {
                 window.location.href = "/";
             }
        }

        // Init
        setVolume(1);
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>