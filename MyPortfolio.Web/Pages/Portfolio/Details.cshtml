@page "{id:int}"
@model MyPortfolio.Web.Pages.Portfolio.DetailsModel
@{
    ViewData["Title"] = Model.PortfolioItem.Title;
}

<div class="container-fluid p-0">
    <div class="p-5 d-flex align-items-end gap-5 glass-panel m-4 mt-0 border-0"
         style="background: linear-gradient(to bottom, rgba(0,0,0,0.2), #121212);">

        <div class="neumorph-btn p-1" style="border-radius: 8px; cursor: default;">
            <img src="@Model.PortfolioItem.ImageUrl" class="rounded shadow" style="width: 250px; height: 250px; object-fit: cover;">
        </div>

        <div>
            <span class="clay-badge bg-dark mb-2 d-inline-block">Project Detail</span>
            <h1 class="glitch-text display-1 fw-bold mb-3" data-text="@Model.PortfolioItem.Title">@Model.PortfolioItem.Title</h1>

            <div class="d-flex align-items-center gap-2 text-white-50 fs-5">
                <i class="fas fa-code text-success"></i>
                <span class="fw-bold text-white">@Model.PortfolioItem.Artist</span>
                <span>•</span>
                <span>@Model.PortfolioItem.CreatedDate.ToString("yyyy")</span>
            </div>

            <div class="mt-4 d-flex gap-3">
                <button class="neumorph-btn rounded-circle text-success" style="width: 60px; height: 60px; font-size: 1.5rem;" onclick="playCurrentSong()">
                    <i class="fas fa-play"></i>
                </button>
                <a href="/Portfolio/Edit/@Model.PortfolioItem.Id" class="neumorph-btn px-4 rounded-pill text-decoration-none">Edit Project</a>
            </div>
        </div>
    </div>

    <div class="row px-5 pb-5">
        <div class="col-lg-8">
            <h3 class="text-white fw-bold mb-4">Lyrics / Content</h3>
            <div class="glass-panel p-4" style="min-height: 400px;">
                <div id="lyrics-display" class="d-flex flex-column gap-3">
                    <div class="text-muted">Loading content...</div>
                </div>
            </div>
            <textarea id="raw-lyrics" style="display:none;">@Model.PortfolioItem.Lyrics</textarea>
        </div>

        <div class="col-lg-4">
            <h3 class="text-white fw-bold mb-4">Tech Specs</h3>
            <div class="glass-panel p-4">
                <p class="text-white-50">@Model.PortfolioItem.Description</p>

                <div class="mt-4">
                    <span class="clay-badge bg-primary me-2 mb-2 d-inline-block">.NET 8</span>
                    <span class="clay-badge bg-info me-2 mb-2 d-inline-block">PostgreSQL</span>
                    <span class="clay-badge bg-warning text-dark me-2 mb-2 d-inline-block">Render</span>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        // --- 1. TỰ ĐỘNG PHÁT BÀI NÀY KHI VÀO TRANG ---
        $(document).ready(function() {
            var audioUrl = '@Model.PortfolioItem.AudioUrl';
            if (audioUrl && audioUrl.length > 0) {
                // Gọi hàm playMusic đã có sẵn ở _Layout
                playMusic(
                    '@Model.PortfolioItem.AudioUrl',
                    '@Model.PortfolioItem.Title',
                    '@Model.PortfolioItem.ImageUrl',
                    '', // Description (không cần thiết ở đây)
                    '@Model.PortfolioItem.Artist'
                );
            }
        });

        // Nút Play to ở trang Details
        function playCurrentSong() {
            playMusic(
                '@Model.PortfolioItem.AudioUrl',
                '@Model.PortfolioItem.Title',
                '@Model.PortfolioItem.ImageUrl',
                '',
                '@Model.PortfolioItem.Artist'
            );
        }

        // --- 2. XỬ LÝ LYRICS ---
        const rawLyrics = document.getElementById('raw-lyrics').value;
        const lyricsContainer = document.getElementById('lyrics-display');
        let lyricsData = [];

        function parseLyrics(lrc) {
            const lines = lrc.split('\n');
            const result = [];
            lines.forEach(line => {
                const match = line.match(/^\[(\d{2}):(\d{2})\.(\d{2})\](.*)/);
                if (match) {
                    const time = parseInt(match[1]) * 60 + parseInt(match[2]) + parseInt(match[3]) / 100;
                    result.push({ time, text: match[4].trim() });
                }
            });
            return result;
        }

        // Render Lyrics
        if (rawLyrics && rawLyrics.trim().length > 0) {
            lyricsData = parseLyrics(rawLyrics);
            if (lyricsData.length > 0) {
                lyricsContainer.innerHTML = lyricsData.map((line, index) =>
                    `<div class="lyrics-line" id="line-${index}" onclick="seekTo(${line.time})">${line.text}</div>`
                ).join('');
            } else {
                lyricsContainer.innerHTML = `<div class="text-gray" style="white-space: pre-line;">${rawLyrics}</div>`;
            }
        } else {
            lyricsContainer.innerHTML = '<div class="text-muted fst-italic">Chưa có lời bài hát.</div>';
        }

        // --- 3. SYNC LYRICS (Nghe sự kiện từ _Layout) ---
        window.addEventListener('audioTimeUpdate', function(e) {
            const currentTime = e.detail.currentTime;
            let activeIndex = -1;

            for (let i = 0; i < lyricsData.length; i++) {
                if (currentTime >= lyricsData[i].time) activeIndex = i;
                else break;
            }

            if (activeIndex !== -1) {
                document.querySelectorAll('.lyrics-line').forEach(el => el.classList.remove('active'));
                const line = document.getElementById(`line-${activeIndex}`);
                if (line) {
                    line.classList.add('active');
                    line.scrollIntoView({ behavior: "smooth", block: "center" });
                }
            }
        });

        // --- 4. TUA KHI BẤM VÀO LỜI ---
        function seekTo(time) {
            var audio = document.getElementById('audio-player'); // Lấy audio từ Layout
            if(audio) {
                audio.currentTime = time;
                audio.play();
                // Cập nhật icon play ở Layout
                var layoutPlayIcon = document.getElementById('play-icon');
                if(layoutPlayIcon) {
                    layoutPlayIcon.classList.remove('fa-play');
                    layoutPlayIcon.classList.add('fa-pause');
                }
            }
        }
    </script>
}
}