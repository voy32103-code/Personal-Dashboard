@page
@model IndexModel
@using System.Text.Json
@{
    ViewData["Title"] = "Thư Viện Dự Án";
    // Serialize danh sách bài hát thành JSON để nạp vào Playlist
    var allSongsJson = JsonSerializer.Serialize(Model.Projects.Select(p => new
    {
        audioUrl = p.AudioUrl,
        title = p.Title,
        imageUrl = p.ImageUrl,
        artist = p.Artist
    }));
}

<div class="p-4 sticky-top" style="z-index: 10;">
    <form method="get" class="d-flex gap-2 align-items-center">
        <div class="flex-grow-1 position-relative">
            <i class="fas fa-search position-absolute text-white-50" style="top: 50%; left: 15px; transform: translateY(-50%);"></i>
            <input type="text" name="SearchString" value="@Model.SearchString"
                   class="neumorph-input w-100 ps-5" placeholder="Tìm kiếm dự án, công nghệ...">
            <input type="hidden" name="Mode" value="@Model.Mode" />
        </div>
        <button class="neumorph-btn rounded-circle" style="width: 48px; height: 48px;"><i class="fas fa-filter"></i></button>
    </form>
</div>

<div class="px-4 pb-5">
    <h2 class="glitch-text mb-4 fs-3" data-text="@ViewData["Title"]">@ViewData["Title"]</h2>

    <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-4">
        @foreach (var item in Model.Projects)
        {
            <div class="col">
                <div class="glass-panel glass-card-hover p-3 h-100 d-flex flex-column position-relative"
                     onclick='playMusic(
                         "@item.AudioUrl",
                         "@item.Title",
                         "@item.ImageUrl",
                         "@item.Description",
                         "@item.Artist",
                         @Html.Raw(allSongsJson)
                     )'>

                    <div class="position-relative mb-3">
                        <img src="@(string.IsNullOrEmpty(item.ImageUrl) ? "https://via.placeholder.com/200" : item.ImageUrl)"
                             class="w-100 rounded shadow-lg" style="aspect-ratio: 1/1; object-fit: cover;">

                        <span class="clay-badge bg-primary position-absolute bottom-0 start-0 m-2 shadow-sm" style="font-size: 0.7rem;">
                            @item.Artist
                        </span>
                    </div>

                    <div class="flex-grow-1">
                        <a href="/Portfolio/Details/@item.Id"
                           class="text-white text-decoration-none fw-bold fs-5 stop-prop hover-underline">
                            @item.Title
                        </a>
                        <p class="text-white-50 small mt-1 text-truncate">@item.Description</p>
                    </div>

                    <button type="button" class="btn position-absolute top-0 end-0 m-2 text-white stop-prop"
                            onclick="toggleHeart(event, @item.Id, this)">
                        @if (item.IsFavorite)
                        {
                            <i class="fas fa-heart text-danger heart-anim"></i>
                        }
                        else
                        {
                            <i class="far fa-heart"></i>
                        }
                    </button>

                    @if (User.Identity.IsAuthenticated)
                    {
                        <div class="mt-3 d-flex justify-content-between align-items-center stop-prop">
                            <a asp-page="./Portfolio/Edit" asp-route-id="@item.Id" class="text-muted small hover-white text-decoration-none"><i class="fas fa-pen"></i></a>
                            <a asp-page="./Portfolio/Delete" asp-route-id="@item.Id" class="text-muted small hover-white text-decoration-none"><i class="fas fa-trash"></i></a>
                        </div>
                    }
                </div>
                <div id="playlist-container" class="row ..."> </div>
            </div>
        }
    </div>
</div>

@Html.AntiForgeryToken()
<script>
    // Chặn sự kiện click (stop-prop) để không kích hoạt playMusic của thẻ cha
    document.querySelectorAll('.stop-prop').forEach(el => {
        el.addEventListener('click', e => {
            e.stopPropagation();
        });
    });
    var el = document.getElementById('playlist-container');
    var sortable = Sortable.create(el, {
        animation: 150,
        ghostClass: 'bg-secondary', // Class khi đang kéo
        onEnd: function (evt) {
            // Gửi thứ tự mới lên Server (evt.newIndex)
            console.log("Đã đổi vị trí từ " + evt.oldIndex + " sang " + evt.newIndex);
            // Gọi API update OrderIndex tại đây
        }
    });

    // AJAX Thả tim
    function toggleHeart(e, id, btn) {
        e.stopPropagation();
        e.preventDefault();

        var icon = btn.querySelector('i');
        var token = document.querySelector('input[name="__RequestVerificationToken"]').value;

        fetch(`?handler=ToggleHeart&id=${id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'RequestVerificationToken': token }
        })
        .then(r => r.json()).then(d => {
            if(d.success) icon.className = d.isFavorite ? "fas fa-heart text-danger heart-anim" : "far fa-heart";
        });
    }
</script>